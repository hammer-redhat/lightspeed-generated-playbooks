---
# ============================================================================
# Redis Cluster Configuration Generator with Bitbucket Integration
# ============================================================================
# 
# BITBUCKET AUTHENTICATION REQUIREMENTS:
# ======================================
# This playbook requires a Workspace Access Token or Personal Access Token
# (NOT a Repository Access Token - those don't work for git operations)
#
# The playbook will automatically test both Bearer token and Basic Auth
# methods and use whichever works with your token.
#
# How to create the correct token:
#   1. Go to Bitbucket Workspace Settings → Access Tokens (or Personal Settings)
#   2. Click "Create Access Token"
#   3. Name: "AAP Redis Automation"
#   4. Required Scopes:
#      ☑️  Workspace: Read
#      ☑️  Projects: Write
#      ☑️  Repositories: Write
#      ☑️  Pull requests: Write
#   5. Copy the generated token
#
# IMPORTANT: Workspace Access Tokens (ATCTT...) use "x-token-auth" as the 
# username with Basic Auth, not your Bitbucket username!
#
# Required AAP Survey Variables:
#   - bitbucket_username: Your Bitbucket username (for git operations)
#   - bitbucket_api_token: The Workspace/Personal Access Token (see above)
#   - git_repo_url: Your Bitbucket repository URL
#
# ============================================================================

- name: Generate Redis Cluster Configuration and Create Pull Request (AAP Version)
  hosts: localhost
  gather_facts: yes
  
  vars:
    # NOTE: Variables passed via Survey/extra_vars will override these defaults
    # Do NOT use self-referencing defaults like "{{ var | default('value') }}" - it causes recursive loops!
    
    # HA defaults (will be overridden by extra_vars if provided)
    slave_ha_grace_period: 120
    slave_ha_cooldown_period: 240
    slave_ha_bdb_cooldown_period: 360
    
    # LDAP defaults (should be overridden by extra_vars in production)
    ldaps_url: "ldaps://mdsem.example.com:636"
    bind_dn: "cn=mbf-redis-ro-serviceid,ou=TrustedApplications,ou=FrameworkSystems,o=xyz"
    
    # Password/secret defaults (MUST be overridden via extra_vars/vault in production)
    cluster_admin_password: "CHANGEME"
    cluster_admin_password_active: "CHANGEME"
    bind_pass: "CHANGEME"
    secret_hi: "CHANGEME"
    
    # Computed variables (these are fine as they don't self-reference)
    memory_size: "{{ (memory_size_gb | default(8) | int * 1073741824) | int }}"  # Convert GB to bytes
    git_repo_local_path: "/tmp/redis-configs-{{ ansible_date_time.epoch }}"
    git_branch_prefix: "redis-deployment"
    
    # Generated file configuration
    output_filename: "redis_cluster_{{ cluster_name | regex_replace('[^a-zA-Z0-9]', '_') }}_{{ ansible_date_time.epoch }}.yml"
    output_dir: "{{ git_repo_local_path }}/deployments"
    
    # Git configuration
    git_default_branch: "main"  # Default branch for PRs (override if repo uses 'master' or other)
    git_branch_name: "{{ git_branch_prefix }}-{{ cluster_name | regex_replace('[^a-zA-Z0-9]', '-') }}-{{ ansible_date_time.epoch }}"
    pr_title: "Redis Cluster Deployment: {{ cluster_name }} ({{ environment }})"
    pr_body: |
      ## Redis Cluster Deployment Configuration
      
      **Environment:** {{ environment | upper }}
      **Cluster Name:** {{ cluster_name }}
      **Redis Version:** {{ redis_version }}
      **BDB Version:** {{ bdb_version }}
      
      ### Configuration Details
      - **Primary Cluster:** {{ cluster_master }}
      - **Active Cluster:** {{ cluster_master_active }}
      - **Database Name:** {{ database_name }}
      - **Database Port:** {{ database_port }}
      - **Memory Size:** {{ memory_size_gb }}GB
      - **Sharding:** {{ 'Enabled (' + (shards_count | string) + ' shards)' if sharding_enabled else 'Disabled' }}
      - **Replication:** {{ 'Enabled' if replication_enabled else 'Disabled' }}
      - **TLS Mode:** {{ tls_mode }}
      - **Data Persistence:** {{ data_persistence }}
      - **HA Enabled:** {{ slave_ha_enabled }}
      
      ### Generated Configuration
      This PR contains the generated Redis cluster configuration file for deployment.
      
      **File:** `{{ output_filename }}`
      
      Please review and approve for deployment to **{{ environment | upper }}**.
      
      ---
      *Generated automatically by Ansible Automation Platform on {{ ansible_date_time.iso8601 }}*
    
    # Service IDs, Redis Roles, and ACLs should be passed via extra_vars
    # These defaults are set via Jinja2 in tasks if not provided
    _service_ids_default:
      - {'name': 'mbf-redis-admin-serviceid', 'dn': 'cn=mbf-redis-admin-serviceid,ou=trustedapplications,ou=frameworksystems,o=xyz', 'role_uids': [1]}
      - {'name': 'mbf-redis-rw-serviceid', 'dn': 'cn=mbf-redis-rw-serviceid,ou=trustedapplications,ou=frameworksystems,o=xyz', 'role_uids': [4]}
      - {'name': 'mbf-redis-ro-serviceid', 'dn': 'cn=mbf-redis-ro-serviceid,ou=trustedapplications,ou=frameworksystems,o=xyz', 'role_uids': [5]}
      - {'name': 'red-cv-serviceid', 'dn': 'cn=red-cv-serviceid,ou=trustedapplications,ou=frameworksystems,o=xyz', 'role_uids': [3]}
    
    _redis_roles_default:
      - {'name': 'Cluster Member', 'management': 'cluster_membr'}
      - {'name': 'Cluster Viewer', 'management': 'cluster_viewr'}
      - {'name': 'DB Member', 'management': 'db_membr'}
      - {'name': 'DB Viewer', 'management': 'db_viewr'}
    
    _acls_default:
      - {'name': 'Read Only', 'acl': '+@read YYYYYYYY'}
      - {'name': 'Not dangerous', 'acl': '+@all YYYYYYYY'}
      - {'name': 'Not dangerous extended', 'acl': '+@all YYYYYYYY'}
      - {'name': 'Read Only extended', 'acl': '+@read YYYYYYYY'}
    
    # CRDB Configuration
    crdbs:
      - name: "{{ database_name }}"
        causal_consistency: false
        encryption: true
        default_db_config:
          name: "{{ database_name }}"
          data_persistence: "{{ data_persistence }}"
          proxy_policy: "all-nodes"
          replication: "{{ replication_enabled }}"
          default_user: false
          memory_size: "{{ memory_size }}"
          sharding: "{{ sharding_enabled }}"
          shard_key_regex:
            - regex: ".*{(?<tag>.*)}.*"
            - regex: "(?<tag>.*)"
          shards_count: "{{ shards_count }}"
          port: "{{ database_port }}"
          enforce_client_authentication: "disabled"
          tls_mode: "{{ tls_mode }}"
          roles_permissions:
            - {redis_acl_uid: 1, role_uid: 1}
            - {redis_acl_uid: 4, role_uid: 4}
            - {redis_acl_uid: 5, role_uid: 5}
            - {redis_acl_uid: 2, role_uid: 3}
        instances:
          - cluster:
              url: "https://{{ cluster_name }}:9443"
              credentials:
                username: "root@{{ cluster_master }}"
                password: "{{ cluster_admin_password | trim }}"
              name: "{{ cluster_name }}"
            compression: 3
          - cluster:
              url: "https://{{ cluster_name_active }}:9443"
              credentials:
                username: "root@{{ cluster_master_active }}"
                password: "{{ cluster_admin_password_active | trim }}"
              name: "{{ cluster_name_active }}"
            compression: 3
    
    # PR Configuration
    pr_reviewers: "{{ pr_reviewers_list.split(',') | map('trim') | select | list if pr_reviewers_list else [] }}"

  tasks:
    # ============================================================================
    # PREREQUISITE CHECKS
    # ============================================================================
    
    - name: Display banner
      ansible.builtin.debug:
        msg:
          - "╔════════════════════════════════════════════════════════════════╗"
          - "║  Redis Cluster Configuration Automation - AAP Version         ║"
          - "║  Environment: {{ environment | upper }}                                            ║"
          - "╚════════════════════════════════════════════════════════════════╝"

    - name: Display survey inputs summary
      ansible.builtin.debug:
        msg:
          - "Configuration Summary from Survey:"
          - "  Cluster: {{ cluster_name }}"
          - "  Environment: {{ environment }}"
          - "  Redis Version: {{ redis_version }}"
          - "  Database: {{ database_name }} (Port: {{ database_port }})"
          - "  Memory: {{ memory_size_gb }}GB"
          - "  Sharding: {{ 'Enabled (' + (shards_count | string) + ' shards)' if sharding_enabled else 'Disabled' }}"
          - "  Replication: {{ 'Enabled' if replication_enabled else 'Disabled' }}"
          - "  TLS: {{ tls_mode }}"
          - "  HA: {{ slave_ha_enabled }}"

    - name: Check if git is installed
      ansible.builtin.command: git --version
      register: git_version_check
      changed_when: false
      failed_when: false

    - name: Display git status
      ansible.builtin.debug:
        msg: "✓ Git is installed: {{ git_version_check.stdout }}"
      when: git_version_check.rc == 0

    - name: Fail if git is not installed
      ansible.builtin.fail:
        msg: |
          ✗ Git is not installed on the execution node
          
          Please install git on the AAP execution environment:
            Add 'git' to the EE dependencies
      when: git_version_check.rc != 0

    - name: Check if python3 is installed
      ansible.builtin.command: python3 --version
      register: python_version_check
      changed_when: false
      failed_when: false

    - name: Display python status
      ansible.builtin.debug:
        msg: "✓ Python3 is installed: {{ python_version_check.stdout }}"
      when: python_version_check.rc == 0

    - name: Check if PyYAML is available
      ansible.builtin.command: python3 -c "import yaml"
      register: pyyaml_check
      changed_when: false
      failed_when: false

    - name: Display PyYAML status
      ansible.builtin.debug:
        msg: "✓ PyYAML is installed"
      when: pyyaml_check.rc == 0

    - name: Check Bitbucket credentials for PR creation
      ansible.builtin.debug:
        msg: "✓ Bitbucket credentials provided - PRs will be created automatically"
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Warn about PR creation
      ansible.builtin.debug:
        msg: |
          ⚠ Pull Request will not be created automatically
          Reason: {{ 'PR creation disabled in survey' if create_pull_request == 'no' else 'Bitbucket credentials not provided' }}
          Branch will be pushed but PR must be created manually
      when: create_pull_request == 'no' or (bitbucket_username | default('') | length == 0) or (bitbucket_api_token | default('') | length == 0)

    - name: Prerequisite check complete
      ansible.builtin.debug:
        msg:
          - ""
          - "════════════════════════════════════════════════════════════════"
          - "All checks passed! Proceeding with configuration generation..."
          - "════════════════════════════════════════════════════════════════"
          - ""

    # ============================================================================
    # MAIN TASKS
    # ============================================================================
    
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - cluster_name is defined
          - cluster_master is defined
          - redis_version is defined
          - git_repo_url is defined
          - database_name is defined
        fail_msg: "Missing required variables from survey"
        success_msg: "All required variables are defined"

    - name: Display configuration summary
      ansible.builtin.debug:
        msg:
          - "=== Final Configuration ==="
          - "Cluster Name: {{ cluster_name }}"
          - "Environment: {{ environment }}"
          - "Redis Version: {{ redis_version }}"
          - "Database: {{ database_name }}"
          - "Memory: {{ memory_size_gb }}GB ({{ memory_size }} bytes)"
          - "Output File: {{ output_filename }}"
          - "Git Branch: {{ git_branch_name }}"

    - name: Clean up existing repository directory
      ansible.builtin.file:
        path: "{{ git_repo_local_path }}"
        state: absent

    - name: Extract Bitbucket host from repository URL
      ansible.builtin.set_fact:
        bitbucket_host: "{{ git_repo_url | regex_replace('^https://[^@]*@?([^/]+)/.*$', '\\1') | regex_replace('^git@([^:]+):.*$', '\\1') }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Display extracted Bitbucket host
      ansible.builtin.debug:
        msg: "Using Bitbucket host: {{ bitbucket_host }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Configure git credential helper for HTTPS authentication
      ansible.builtin.command:
        cmd: "{{ item }}"
      loop:
        - "git config --global credential.helper store"
        - "git config --global user.name 'Ansible Automation Platform'"
        - "git config --global user.email 'aap-redis-automation@example.com'"
      changed_when: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Create git credentials file for Bitbucket
      ansible.builtin.copy:
        content: |
          https://{{ bitbucket_username }}:{{ bitbucket_api_token }}@{{ bitbucket_host }}
        dest: "{{ ansible_env.HOME }}/.git-credentials"
        mode: '0600'
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
      no_log: true

    - name: Clone git repository
      ansible.builtin.git:
        repo: "{{ git_repo_url }}"
        dest: "{{ git_repo_local_path }}"
        version: main
        accept_hostkey: yes
      register: git_clone
      environment:
        GIT_TERMINAL_PROMPT: "0"  # Disable interactive prompts

    - name: Extract repository path from URL
      ansible.builtin.set_fact:
        repo_path: "{{ git_repo_url | regex_replace('^https://[^@]*@?[^/]+/(.*)$', '\\1') | regex_replace('^git@[^:]+:(.*)$', '\\1') }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Display repository path for verification
      ansible.builtin.debug:
        msg:
          - "Bitbucket Host: {{ bitbucket_host }}"
          - "Repository Path: {{ repo_path }}"
          - "Username: {{ bitbucket_username }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Normalize git remote URL to use credentials (remove any embedded username)
      ansible.builtin.command:
        cmd: "git remote set-url origin https://{{ bitbucket_username }}:{{ bitbucket_api_token }}@{{ bitbucket_host }}/{{ repo_path }}"
        chdir: "{{ git_repo_local_path }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
      no_log: true
      changed_when: false

    - name: Verify git remote URL (masked)
      ansible.builtin.command:
        cmd: git remote get-url origin
        chdir: "{{ git_repo_local_path }}"
      register: git_remote_url
      changed_when: false
      no_log: false

    - name: Display masked remote URL
      ansible.builtin.debug:
        msg: "Git remote URL set to: {{ git_remote_url.stdout | regex_replace('(https://)([^:]+):([^@]+)(@.+)', '\\1\\2:***TOKEN***\\4') }}"
      when: git_remote_url is defined

    - name: Check token format
      ansible.builtin.set_fact:
        token_prefix: "{{ bitbucket_api_token[:5] if bitbucket_api_token | length >= 5 else 'unknown' }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Display token type hint
      ansible.builtin.debug:
        msg:
          - "Token prefix detected: {{ token_prefix }}***"
          - "{{ 'WARNING: This looks like a Repository Access Token (ATATT prefix) - these do NOT work!' if token_prefix.startswith('ATATT') else 'Token format looks valid' }}"
          - "{{ 'You need a Workspace or Personal Access Token instead!' if token_prefix.startswith('ATATT') else '' }}"
      when: 
        - token_prefix is defined
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Test Bitbucket API authentication with Bearer token
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/user"
        method: GET
        headers:
          Authorization: "Bearer {{ bitbucket_api_token }}"
        status_code: 200
      register: bitbucket_auth_test_bearer
      ignore_errors: yes
      no_log: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Test Bitbucket API authentication with Basic Auth (if Bearer failed)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/user"
        method: GET
        user: "x-token-auth"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        status_code: 200
      register: bitbucket_auth_test_basic
      ignore_errors: yes
      no_log: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - bitbucket_auth_test_bearer is failed

    - name: Set authentication method based on test results
      ansible.builtin.set_fact:
        bitbucket_auth_test: "{{ bitbucket_auth_test_bearer if bitbucket_auth_test_bearer is succeeded else bitbucket_auth_test_basic }}"
        bitbucket_auth_method: "{{ 'bearer' if bitbucket_auth_test_bearer is succeeded else 'basic' }}"
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Display API authentication result
      ansible.builtin.debug:
        msg: 
          - "Bitbucket API authentication: {{ 'SUCCESS ✓' if bitbucket_auth_test is succeeded else 'FAILED ✗' }}"
          - "Authentication method: {{ bitbucket_auth_method | upper if bitbucket_auth_method is defined else 'N/A' }}"
      when: 
        - bitbucket_auth_test is defined
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Fail if API authentication failed
      ansible.builtin.fail:
        msg: |
          ╔════════════════════════════════════════════════════════════════╗
          ║  Bitbucket API Authentication Failed (401 Unauthorized)        ║
          ╚════════════════════════════════════════════════════════════════╝
          
          ❌ BOTH authentication methods failed!
          {{ '   Token starts with: ' + token_prefix + '*** (Repository Access Token)' if token_prefix is defined and token_prefix.startswith('ATATT') else '' }}
          
          Error from Bitbucket API:
          "{{ bitbucket_auth_test.json.error.message if bitbucket_auth_test.json is defined and bitbucket_auth_test.json.error is defined else 'Token is invalid, expired, or not supported for this endpoint' }}"
          
          ⚠️  WRONG TOKEN TYPE CONFIRMED!
          
          Repository Access Tokens (ATATT...) do NOT work for:
            ✗ API endpoint /2.0/user
            ✗ Git push operations  
            ✗ Pull request creation
          
          You MUST create a WORKSPACE ACCESS TOKEN or PERSONAL ACCESS TOKEN:
          
          ┌─────────────────────────────────────────────────────────────┐
          │ How to Create the Correct Token:                            │
          ├─────────────────────────────────────────────────────────────┤
          │                                                              │
          │ OPTION 1: Workspace Access Token (Recommended)              │
          │ ──────────────────────────────────────────────────────────  │
          │ 1. Go to Workspace Settings → Access Tokens                 │
          │ 2. Click "Create Access Token"                              │
          │ 3. Name: "AAP Redis Automation"                             │
          │ 4. Scopes:                                                   │
          │    ☑️  Workspace: Read                                       │
          │    ☑️  Projects: Write                                       │
          │    ☑️  Repositories: Write                                   │
          │    ☑️  Pull requests: Write                                  │
          │ 5. Copy the token                                            │
          │                                                              │
          │ OPTION 2: Personal Access Token                              │
          │ ──────────────────────────────────────────────────────────  │
          │ 1. Go to Personal Settings → Access Tokens                  │
          │ 2. Click "Create Access Token"                              │
          │ 3. Same scopes as above                                      │
          │                                                              │
          └─────────────────────────────────────────────────────────────┘
          
          ══════════════════════════════════════════════════════════════
          IMPORTANT: Where to Create the Token
          ══════════════════════════════════════════════════════════════
          
          ✅ CORRECT LOCATION:
             Bitbucket Cloud → Your Workspace → Settings → Access Tokens
             (NOT in Repository Settings!)
          
          ✅ OR: 
             Bitbucket Cloud → Personal Settings → Access Tokens
          
          ❌ WRONG LOCATION:
             Repository Settings → Access Tokens 
             (These create Repository tokens that DON'T work!)
          
          ══════════════════════════════════════════════════════════════
          
          Current username: {{ bitbucket_username }}
          {{ 'Current token: ' + token_prefix + '*** (INVALID - Repository Access Token)' if token_prefix is defined and token_prefix.startswith('ATATT') else 'Token type: Unknown' }}
      when:
        - bitbucket_auth_test is defined
        - bitbucket_auth_test is failed
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Extract workspace and repo for repository check
      ansible.builtin.set_fact:
        check_workspace: "{{ git_repo_url | regex_replace('^https://[^@]*@?[^/]+/([^/]+)/.*$', '\\1') | regex_replace('^git@[^:]+:([^/]+)/.*$', '\\1') }}"
        check_repo_slug: "{{ git_repo_url | regex_replace('^.*/([^/]+)\\.git$', '\\1') | regex_replace('^.*/([^/]+)$', '\\1') }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Test repository access (Bearer auth)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/repositories/{{ check_workspace }}/{{ check_repo_slug }}"
        method: GET
        headers:
          Authorization: "Bearer {{ bitbucket_api_token }}"
        status_code: 200
      register: repo_access_test
      ignore_errors: yes
      no_log: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - bitbucket_auth_method == 'bearer'

    - name: Test repository access (Basic auth)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/repositories/{{ check_workspace }}/{{ check_repo_slug }}"
        method: GET
        user: "x-token-auth"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        status_code: 200
      register: repo_access_test
      ignore_errors: yes
      no_log: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - bitbucket_auth_method == 'basic'

    - name: Display repository access result
      ansible.builtin.debug:
        msg: 
          - "Repository access check: {{ 'SUCCESS ✓' if repo_access_test is succeeded else 'FAILED ✗' }}"
          - "Repository: {{ check_workspace }}/{{ check_repo_slug }}"
      when: 
        - repo_access_test is defined
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Fail if repository access check failed
      ansible.builtin.fail:
        msg: |
          ╔════════════════════════════════════════════════════════════════╗
          ║  Repository Access Failed                                       ║
          ╚════════════════════════════════════════════════════════════════╝
          
          Cannot access repository: {{ check_workspace }}/{{ check_repo_slug }}
          
          Possible issues:
          ─────────────────────────────────────────────────────────────────
          1. ❌ Repository does not exist in this workspace
          2. ❌ Your token doesn't have access to this repository  
          3. ❌ The workspace/repository name is incorrect
          4. ❌ Token missing required scopes
          
          Verification Details:
          ─────────────────────────────────────────────────────────────────
          • Repository URL: {{ git_repo_url }}
          • Workspace: {{ check_workspace }}
          • Repository: {{ check_repo_slug }}
          • Username: {{ bitbucket_username }}
          
          Required Token Scopes:
          ─────────────────────────────────────────────────────────────────
          ☑️  Repositories: Write
          ☑️  Pull requests: Write
          
          Error: {{ repo_access_test.msg | default('Unknown error') }}
      when:
        - repo_access_test is defined
        - repo_access_test is failed
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Create deployments directory if it doesn't exist
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'

    - name: Create new git branch
      ansible.builtin.command:
        cmd: git checkout -b {{ git_branch_name }}
        chdir: "{{ git_repo_local_path }}"
      register: git_branch_create

    - name: Set default values for template variables if not provided
      ansible.builtin.set_fact:
        service_ids: "{{ service_ids | default(_service_ids_default) }}"
        redis_roles: "{{ redis_roles | default(_redis_roles_default) }}"
        acls: "{{ acls | default(_acls_default) }}"

    - name: Override with vault credentials if provided
      ansible.builtin.set_fact:
        cluster_admin_password: "{{ vault_cluster_admin_password | default(cluster_admin_password) }}"
        cluster_admin_password_active: "{{ vault_cluster_admin_password_active | default(cluster_admin_password_active) }}"
        bind_pass: "{{ vault_bind_pass | default(bind_pass) }}"
        secret_hi: "{{ vault_secret_hi | default(secret_hi) }}"

    - name: Generate Redis cluster configuration from template
      ansible.builtin.template:
        src: templates/redis_cluster_config.yml.j2
        dest: "{{ output_dir }}/{{ output_filename }}"
        mode: '0644'
      register: template_result

    - name: Display generated file location
      ansible.builtin.debug:
        msg: "✓ Configuration file generated: {{ output_dir }}/{{ output_filename }}"

    - name: Validate generated YAML file
      ansible.builtin.command:
        cmd: "python3 -c 'import yaml; yaml.safe_load(open(\"{{ output_dir }}/{{ output_filename }}\"))'"
      register: yaml_validation
      changed_when: false
      failed_when: false
      when: pyyaml_check.rc == 0

    - name: Display YAML validation result
      ansible.builtin.debug:
        msg: "{{ 'YAML validation: PASSED ✓' if yaml_validation.rc == 0 else 'YAML validation: FAILED ✗ - ' + yaml_validation.stderr }}"
      when: pyyaml_check.rc == 0

    - name: Configure git user for commit
      ansible.builtin.command:
        cmd: "{{ item }}"
        chdir: "{{ git_repo_local_path }}"
      loop:
        - "git config user.name 'Ansible Automation Platform'"
        - "git config user.email 'aap-redis-automation@example.com'"
      changed_when: false

    - name: Stage generated file
      ansible.builtin.command:
        cmd: git add "{{ output_dir }}/{{ output_filename }}"
        chdir: "{{ git_repo_local_path }}"

    - name: Commit changes
      ansible.builtin.command:
        cmd: >
          git commit -m "Add Redis cluster configuration for {{ cluster_name }}"
          -m "Environment: {{ environment }}"
          -m "Redis Version: {{ redis_version }}"
          -m "BDB Version: {{ bdb_version }}"
          -m "Database: {{ database_name }} (Port: {{ database_port }})"
          -m "Memory: {{ memory_size_gb }}GB"
          -m "Cluster Master: {{ cluster_master }}"
          -m ""
          -m "Generated by AAP Job Template: {{ tower_job_template_name | default('Redis Config Generator') }}"
          -m "Job ID: {{ tower_job_id | default('N/A') }}"
          -m "User: {{ tower_user_name | default('Unknown') }}"
        chdir: "{{ git_repo_local_path }}"
      register: git_commit

    - name: Push branch to remote
      ansible.builtin.command:
        cmd: git push origin {{ git_branch_name }}
        chdir: "{{ git_repo_local_path }}"
      register: git_push
      environment:
        GIT_TERMINAL_PROMPT: "0"  # Disable interactive prompts
        GIT_ASKPASS: "echo"  # Prevent password prompts

    - name: Extract Bitbucket workspace and repository from URL
      ansible.builtin.set_fact:
        bitbucket_workspace: "{{ git_repo_url | regex_replace('^https://[^@]*@?[^/]+/([^/]+)/.*$', '\\1') | regex_replace('^git@[^:]+:([^/]+)/.*$', '\\1') }}"
        bitbucket_repo_slug: "{{ git_repo_url | regex_replace('^.*/([^/]+)\\.git$', '\\1') | regex_replace('^.*/([^/]+)$', '\\1') }}"
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Debug - Show extracted Bitbucket info
      ansible.builtin.debug:
        msg:
          - "Bitbucket Repo URL: {{ git_repo_url }}"
          - "Extracted Workspace: {{ bitbucket_workspace }}"
          - "Extracted Repo Slug: {{ bitbucket_repo_slug }}"
          - "API URL: https://api.bitbucket.org/2.0/repositories/{{ bitbucket_workspace }}/{{ bitbucket_repo_slug }}/pullrequests"
          - "Source Branch: {{ git_branch_name }}"
          - "Destination Branch: {{ git_default_branch }}"
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Create Pull Request using Bitbucket API (Bearer auth)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/repositories/{{ bitbucket_workspace }}/{{ bitbucket_repo_slug }}/pullrequests"
        method: POST
        headers:
          Authorization: "Bearer {{ bitbucket_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          title: "{{ pr_title }}"
          description: "{{ pr_body }}"
          source:
            branch:
              name: "{{ git_branch_name }}"
          destination:
            branch:
              name: "{{ git_default_branch }}"
          close_source_branch: false
        status_code: 201
        return_content: yes
      register: pr_create
      ignore_errors: yes
      no_log: false  # Temporarily disabled for debugging
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - bitbucket_auth_method == 'bearer'

    - name: Create Pull Request using Bitbucket API (Basic auth)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/repositories/{{ bitbucket_workspace }}/{{ bitbucket_repo_slug }}/pullrequests"
        method: POST
        user: "x-token-auth"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          title: "{{ pr_title }}"
          description: "{{ pr_body }}"
          source:
            branch:
              name: "{{ git_branch_name }}"
          destination:
            branch:
              name: "{{ git_default_branch }}"
          close_source_branch: false
        status_code: 201
        return_content: yes
      register: pr_create
      ignore_errors: yes
      no_log: false  # Temporarily disabled for debugging
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - bitbucket_auth_method == 'basic'

    - name: Debug - Show API error if PR creation failed
      ansible.builtin.debug:
        msg:
          - "⚠ PR creation failed!"
          - "Status: {{ pr_create.status | default('N/A') }}"
          - "Message: {{ pr_create.msg | default('N/A') }}"
          - "Response: {{ pr_create.json | default('N/A') }}"
      when: 
        - pr_create is defined
        - pr_create is failed

    - name: Display PR creation result
      ansible.builtin.debug:
        msg: 
          - "✓ Pull Request created successfully!"
          - "PR #{{ pr_create.json.id }}: {{ pr_create.json.title }}"
          - "URL: {{ pr_create.json.links.html.href }}"
          - "Status: {{ pr_create.json.state }}"
      when: 
        - create_pull_request == 'yes'
        - pr_create is defined
        - pr_create is not skipped
        - pr_create is succeeded

    - name: Display manual PR creation instructions
      ansible.builtin.debug:
        msg:
          - "⚠ Pull Request not created automatically"
          - "Reason: {{ 'PR creation disabled' if create_pull_request == 'no' else 'Bitbucket credentials not provided or invalid' }}"
          - ""
          - "Please create the PR manually:"
          - "  Repository: {{ git_repo_url }}"
          - "  Branch: {{ git_branch_name }}"
          - "  Title: {{ pr_title }}"
          - "  URL: https://bitbucket.org/{{ bitbucket_workspace | default('WORKSPACE') }}/{{ bitbucket_repo_slug | default('REPO') }}/pull-requests/new?source={{ git_branch_name }}&dest={{ git_default_branch }}"
          - ""
          - "✓ Configuration file generated and pushed successfully"
      when: 
        - pr_create is skipped or (pr_create is defined and pr_create is failed)

    - name: Cleanup temporary repository
      ansible.builtin.file:
        path: "{{ git_repo_local_path }}"
        state: absent
      when: git_repo_local_path is defined and git_repo_local_path.startswith('/tmp/')

    - name: Cleanup git credentials file
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.git-credentials"
        state: absent
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
      no_log: true

    - name: Reset git credential helper
      ansible.builtin.command:
        cmd: git config --global --unset credential.helper
      changed_when: false
      failed_when: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Final Summary
      ansible.builtin.debug:
        msg:
          - "╔════════════════════════════════════════════════════════════════╗"
          - "║  AAP Job Complete!                                             ║"
          - "╚════════════════════════════════════════════════════════════════╝"
          - ""
          - "✓ Configuration generated for: {{ cluster_name }}"
          - "✓ Environment: {{ environment | upper }}"
          - "✓ File: {{ output_filename }}"
          - "✓ Branch: {{ git_branch_name }}"
          - "{{ '✓ Pull Request created' if (create_pull_request == 'yes' and pr_create is succeeded) else '⚠ Pull Request needs manual creation' }}"
          - ""
          - "Next steps:"
          - "  1. Review the Pull Request"
          - "  2. Get necessary approvals"
          - "  3. Merge to main branch"
          - "  4. Deploy using the generated configuration"
          - ""
          - "AAP Job ID: {{ tower_job_id | default('N/A') }}"
          - "Executed by: {{ tower_user_name | default('Unknown') }}"

