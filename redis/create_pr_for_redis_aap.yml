---
# ============================================================================
# Redis Cluster Configuration Generator with Bitbucket Integration
# ============================================================================
# 
# SUPPORTS BOTH BITBUCKET CLOUD AND BITBUCKET SERVER/DATA CENTER
# ================================================================
# This playbook automatically detects your Bitbucket environment and adapts:
#   â€¢ Bitbucket Cloud (bitbucket.org)
#   â€¢ Bitbucket Server / Data Center (self-hosted)
#
# BITBUCKET CLOUD AUTHENTICATION:
# ================================
# 
# RECOMMENDED: Use Workspace Access Token (ATCTT...)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# This is the EASIEST approach and works perfectly for git operations!
#   â€¢ Works for: git clone, push, pull (which is what we need!)
#   â€¢ Create at: Workspace Settings â†’ Access Tokens
#   â€¢ Required Scopes: Repositories: Write
#   â€¢ The playbook will generate a PR creation URL for you
#   â€¢ Note: Uses "x-token-auth" as git username (handled automatically)
#
# OPTIONAL: Use App Password for automatic PR creation
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Only needed if you want automatic API-based PR creation (not required!)
#   1. Personal Settings â†’ App passwords
#   2. Required Permissions: Account:Read, Repositories:Write, Pull requests:Write
#   3. Format: Typically "ATBB..." (shorter than workspace tokens)
#
# BITBUCKET SERVER/DATA CENTER AUTHENTICATION:
# =============================================
# 
# Use Personal Access Token or HTTP Access Token
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   â€¢ Create at: User Settings â†’ Personal Access Tokens
#   â€¢ OR: Repository Settings â†’ HTTP Access Tokens
#   â€¢ Required Permissions: Repository Read, Repository Write, Pull Request Read/Write
#   â€¢ Uses Basic Authentication (username + token)
#   â€¢ Example URL: http://bitbucket.example.com:7990/scm/PROJECT/repo.git
#
# Required AAP Survey Variables:
# ===============================
#   - bitbucket_username: Your Bitbucket username
#   - bitbucket_api_token: Workspace Access Token, App Password, or Personal Access Token
#   - git_repo_url: Your Bitbucket repository URL (Cloud or Server format)
#   - create_pull_request: 'yes' or 'no' (API PR creation - optional)
#
# ============================================================================

- name: Generate Redis Cluster Configuration and Create Pull Request (AAP Version)
  hosts: localhost
  gather_facts: yes
  
  vars:
    # NOTE: Variables passed via Survey/extra_vars will override these defaults
    # Do NOT use self-referencing defaults like "{{ var | default('value') }}" - it causes recursive loops!
    
    # HA defaults (will be overridden by extra_vars if provided)
    slave_ha_grace_period: 120
    slave_ha_cooldown_period: 240
    slave_ha_bdb_cooldown_period: 360
    
    # LDAP defaults (should be overridden by extra_vars in production)
    ldaps_url: "ldaps://mdsem.example.com:636"
    bind_dn: "cn=mbf-redis-ro-serviceid,ou=TrustedApplications,ou=FrameworkSystems,o=xyz"
    
    # Password/secret defaults (MUST be overridden via extra_vars/vault in production)
    cluster_admin_password: "CHANGEME"
    cluster_admin_password_active: "CHANGEME"
    bind_pass: "CHANGEME"
    secret_hi: "CHANGEME"
    
    # Computed variables (these are fine as they don't self-reference)
    memory_size: "{{ (memory_size_gb | default(8) | int * 1073741824) | int }}"  # Convert GB to bytes
    git_repo_local_path: "/tmp/redis-configs-{{ ansible_date_time.epoch }}"
    git_branch_prefix: "redis-deployment"
    
    # Generated file configuration
    output_filename: "redis_cluster_{{ cluster_name | regex_replace('[^a-zA-Z0-9]', '_') }}_{{ ansible_date_time.epoch }}.yml"
    output_dir: "{{ git_repo_local_path }}/deployments"
    
    # Git configuration
    git_default_branch: "main"  # Default branch for PRs (override if repo uses 'master' or other)
    git_branch_name: "{{ git_branch_prefix }}-{{ cluster_name | regex_replace('[^a-zA-Z0-9]', '-') }}-{{ ansible_date_time.epoch }}"
    pr_title: "Redis Cluster Deployment: {{ cluster_name }} ({{ environment }})"
    pr_body: |
      ## Redis Cluster Deployment Configuration
      
      **Environment:** {{ environment | upper }}
      **Cluster Name:** {{ cluster_name }}
      **Redis Version:** {{ redis_version }}
      **BDB Version:** {{ bdb_version }}
      
      ### Configuration Details
      - **Primary Cluster:** {{ cluster_master }}
      - **Active Cluster:** {{ cluster_master_active }}
      - **Database Name:** {{ database_name }}
      - **Database Port:** {{ database_port }}
      - **Memory Size:** {{ memory_size_gb }}GB
      - **Sharding:** {{ 'Enabled (' + (shards_count | string) + ' shards)' if sharding_enabled else 'Disabled' }}
      - **Replication:** {{ 'Enabled' if replication_enabled else 'Disabled' }}
      - **TLS Mode:** {{ tls_mode }}
      - **Data Persistence:** {{ data_persistence }}
      - **HA Enabled:** {{ slave_ha_enabled }}
      
      ### Generated Configuration
      This PR contains the generated Redis cluster configuration file for deployment.
      
      **File:** `{{ output_filename }}`
      
      Please review and approve for deployment to **{{ environment | upper }}**.
      
      ---
      *Generated automatically by Ansible Automation Platform on {{ ansible_date_time.iso8601 }}*
    
    # Service IDs, Redis Roles, and ACLs should be passed via extra_vars
    # These defaults are set via Jinja2 in tasks if not provided
    _service_ids_default:
      - {'name': 'mbf-redis-admin-serviceid', 'dn': 'cn=mbf-redis-admin-serviceid,ou=trustedapplications,ou=frameworksystems,o=xyz', 'role_uids': [1]}
      - {'name': 'mbf-redis-rw-serviceid', 'dn': 'cn=mbf-redis-rw-serviceid,ou=trustedapplications,ou=frameworksystems,o=xyz', 'role_uids': [4]}
      - {'name': 'mbf-redis-ro-serviceid', 'dn': 'cn=mbf-redis-ro-serviceid,ou=trustedapplications,ou=frameworksystems,o=xyz', 'role_uids': [5]}
      - {'name': 'red-cv-serviceid', 'dn': 'cn=red-cv-serviceid,ou=trustedapplications,ou=frameworksystems,o=xyz', 'role_uids': [3]}
    
    _redis_roles_default:
      - {'name': 'Cluster Member', 'management': 'cluster_membr'}
      - {'name': 'Cluster Viewer', 'management': 'cluster_viewr'}
      - {'name': 'DB Member', 'management': 'db_membr'}
      - {'name': 'DB Viewer', 'management': 'db_viewr'}
    
    _acls_default:
      - {'name': 'Read Only', 'acl': '+@read YYYYYYYY'}
      - {'name': 'Not dangerous', 'acl': '+@all YYYYYYYY'}
      - {'name': 'Not dangerous extended', 'acl': '+@all YYYYYYYY'}
      - {'name': 'Read Only extended', 'acl': '+@read YYYYYYYY'}
    
    # CRDB Configuration
    crdbs:
      - name: "{{ database_name }}"
        causal_consistency: false
        encryption: true
        default_db_config:
          name: "{{ database_name }}"
          data_persistence: "{{ data_persistence }}"
          proxy_policy: "all-nodes"
          replication: "{{ replication_enabled }}"
          default_user: false
          memory_size: "{{ memory_size }}"
          sharding: "{{ sharding_enabled }}"
          shard_key_regex:
            - regex: ".*{(?<tag>.*)}.*"
            - regex: "(?<tag>.*)"
          shards_count: "{{ shards_count }}"
          port: "{{ database_port }}"
          enforce_client_authentication: "disabled"
          tls_mode: "{{ tls_mode }}"
          roles_permissions:
            - {redis_acl_uid: 1, role_uid: 1}
            - {redis_acl_uid: 4, role_uid: 4}
            - {redis_acl_uid: 5, role_uid: 5}
            - {redis_acl_uid: 2, role_uid: 3}
        instances:
          - cluster:
              url: "https://{{ cluster_name }}:9443"
              credentials:
                username: "root@{{ cluster_master }}"
                password: "{{ cluster_admin_password | trim }}"
              name: "{{ cluster_name }}"
            compression: 3
          - cluster:
              url: "https://{{ cluster_name_active }}:9443"
              credentials:
                username: "root@{{ cluster_master_active }}"
                password: "{{ cluster_admin_password_active | trim }}"
              name: "{{ cluster_name_active }}"
            compression: 3
    
    # PR Configuration
    pr_reviewers: "{{ pr_reviewers_list.split(',') | map('trim') | select | list if pr_reviewers_list else [] }}"

  tasks:
    # ============================================================================
    # PREREQUISITE CHECKS
    # ============================================================================
    
    - name: Display banner
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Redis Cluster Configuration Automation - AAP Version         â•‘"
          - "â•‘  Environment: {{ environment | upper }}                                            â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: Display survey inputs summary
      ansible.builtin.debug:
        msg:
          - "Configuration Summary from Survey:"
          - "  Cluster: {{ cluster_name }}"
          - "  Environment: {{ environment }}"
          - "  Redis Version: {{ redis_version }}"
          - "  Database: {{ database_name }} (Port: {{ database_port }})"
          - "  Memory: {{ memory_size_gb }}GB"
          - "  Sharding: {{ 'Enabled (' + (shards_count | string) + ' shards)' if sharding_enabled else 'Disabled' }}"
          - "  Replication: {{ 'Enabled' if replication_enabled else 'Disabled' }}"
          - "  TLS: {{ tls_mode }}"
          - "  HA: {{ slave_ha_enabled }}"

    - name: Check if git is installed
      ansible.builtin.command: git --version
      register: git_version_check
      changed_when: false
      failed_when: false

    - name: Display git status
      ansible.builtin.debug:
        msg: "âœ“ Git is installed: {{ git_version_check.stdout }}"
      when: git_version_check.rc == 0

    - name: Fail if git is not installed
      ansible.builtin.fail:
        msg: |
          âœ— Git is not installed on the execution node
          
          Please install git on the AAP execution environment:
            Add 'git' to the EE dependencies
      when: git_version_check.rc != 0

    - name: Check if python3 is installed
      ansible.builtin.command: python3 --version
      register: python_version_check
      changed_when: false
      failed_when: false

    - name: Display python status
      ansible.builtin.debug:
        msg: "âœ“ Python3 is installed: {{ python_version_check.stdout }}"
      when: python_version_check.rc == 0

    - name: Check if PyYAML is available
      ansible.builtin.command: python3 -c "import yaml"
      register: pyyaml_check
      changed_when: false
      failed_when: false

    - name: Display PyYAML status
      ansible.builtin.debug:
        msg: "âœ“ PyYAML is installed"
      when: pyyaml_check.rc == 0

    - name: Check Bitbucket credentials for PR creation
      ansible.builtin.debug:
        msg: "âœ“ Bitbucket credentials provided - PRs will be created automatically"
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Warn about PR creation
      ansible.builtin.debug:
        msg: |
          âš  Pull Request will not be created automatically
          Reason: {{ 'PR creation disabled in survey' if create_pull_request == 'no' else 'Bitbucket credentials not provided' }}
          Branch will be pushed but PR must be created manually
      when: create_pull_request == 'no' or (bitbucket_username | default('') | length == 0) or (bitbucket_api_token | default('') | length == 0)

    - name: Prerequisite check complete
      ansible.builtin.debug:
        msg:
          - ""
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "All checks passed! Proceeding with configuration generation..."
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""

    # ============================================================================
    # MAIN TASKS
    # ============================================================================
    
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - cluster_name is defined
          - cluster_master is defined
          - redis_version is defined
          - git_repo_url is defined
          - database_name is defined
        fail_msg: "Missing required variables from survey"
        success_msg: "All required variables are defined"

    - name: Display configuration summary
      ansible.builtin.debug:
        msg:
          - "=== Final Configuration ==="
          - "Cluster Name: {{ cluster_name }}"
          - "Environment: {{ environment }}"
          - "Redis Version: {{ redis_version }}"
          - "Database: {{ database_name }}"
          - "Memory: {{ memory_size_gb }}GB ({{ memory_size }} bytes)"
          - "Output File: {{ output_filename }}"
          - "Git Branch: {{ git_branch_name }}"

    - name: Clean up existing repository directory
      ansible.builtin.file:
        path: "{{ git_repo_local_path }}"
        state: absent

    # ============================================================================
    # GIT AUTHENTICATION SETUP (Supports both Bitbucket Cloud and Server)
    # ============================================================================
    
    - name: Extract Bitbucket host and port from repository URL
      ansible.builtin.set_fact:
        bitbucket_host_with_port: "{{ git_repo_url | regex_replace('^https?://[^@]*@?([^/]+)/.*$', '\\1') | regex_replace('^git@([^:]+):.*$', '\\1') }}"
        bitbucket_host: "{{ git_repo_url | regex_replace('^https?://[^@]*@?([^/:]+).*$', '\\1') | regex_replace('^git@([^:]+):.*$', '\\1') }}"
      
    - name: Detect Bitbucket type (Cloud vs Server/Data Center)
      ansible.builtin.set_fact:
        is_bitbucket_cloud: "{{ 'bitbucket.org' in bitbucket_host }}"
        is_bitbucket_server: "{{ 'bitbucket.org' not in bitbucket_host }}"

    - name: Display Bitbucket environment detection
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Bitbucket Environment Detection:"
          - "  Git Repository URL: {{ git_repo_url }}"
          - "  Host: {{ bitbucket_host }}"
          - "  Host with Port: {{ bitbucket_host_with_port }}"
          - "  Type: {{ 'Bitbucket Cloud' if is_bitbucket_cloud else 'Bitbucket Server/Data Center' }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: Check token format (BEFORE git setup)
      ansible.builtin.set_fact:
        token_prefix: "{{ bitbucket_api_token[:5] if (bitbucket_api_token | default('') | length >= 5) else 'unknown' }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Detect token type for Bitbucket Cloud
      ansible.builtin.set_fact:
        is_workspace_token: "{{ token_prefix.startswith('ATCTT') if token_prefix is defined else false }}"
        is_repo_token: "{{ token_prefix.startswith('ATATT') if token_prefix is defined else false }}"
        is_app_password: "{{ token_prefix.startswith('ATBB') if token_prefix is defined else false }}"
      when: 
        - token_prefix is defined
        - is_bitbucket_cloud

    - name: Display token type detection (Cloud only)
      ansible.builtin.debug:
        msg:
          - "Token Analysis (Bitbucket Cloud):"
          - "  Prefix: {{ token_prefix }}***"
          - "  Workspace Token: {{ is_workspace_token | default(false) }}"
          - "  Repo Token: {{ is_repo_token | default(false) }}"
          - "  App Password: {{ is_app_password | default(false) }}"
      when: 
        - token_prefix is defined
        - is_bitbucket_cloud

    - name: Display token info (Server/Data Center)
      ansible.builtin.debug:
        msg:
          - "Token Analysis (Bitbucket Server/Data Center):"
          - "  Token prefix: {{ token_prefix }}***"
          - "  {{ 'Detected: HTTP Access Token (BBDC)' if token_prefix.startswith('BBDC') else 'Detected: Personal Access Token or other' }}"
          - ""
          - "âš ï¸  IMPORTANT: For Bitbucket Server/Data Center:"
          - "  â€¢ HTTP Access Tokens: May only work for specific repositories"
          - "  â€¢ Personal Access Tokens: Recommended for broader access"
          - "  â€¢ User must have explicit repository permissions"
          - ""
          - "  Token Type Detection:"
          - "  {{ '  HTTP Access Token (Repository-specific)' if token_prefix.startswith('BBDC') else '  Personal Access Token (User-based)' }}"
      when:
        - token_prefix is defined
        - is_bitbucket_server

    - name: Configure git credential helper for HTTPS authentication
      ansible.builtin.command:
        cmd: "{{ item }}"
      loop:
        - "git config --global credential.helper store"
        - "git config --global user.name 'Ansible Automation Platform'"
        - "git config --global user.email 'aap-redis-automation@example.com'"
      changed_when: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Determine git username (Bitbucket Cloud - token-based)
      ansible.builtin.set_fact:
        git_auth_username: "{{ 'x-token-auth' if (is_workspace_token | default(false) or is_repo_token | default(false)) else bitbucket_username }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Determine git username (Bitbucket Server - always use username)
      ansible.builtin.set_fact:
        git_auth_username: "{{ bitbucket_username }}"
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server

    - name: Display git authentication method
      ansible.builtin.debug:
        msg:
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - "Git Authentication Setup:"
          - "  Environment: {{ 'Bitbucket Cloud' if is_bitbucket_cloud else 'Bitbucket Server/Data Center' }}"
          - "  {{ 'Token Type: ' + ('Workspace Access Token (ATCTT)' if (is_workspace_token | default(false)) else 'Repository Access Token (ATATT)' if (is_repo_token | default(false)) else 'App Password (ATBB)' if (is_app_password | default(false)) else 'Personal Access Token') }}"
          - "  Git Username: {{ git_auth_username }}"
          - "  Host: {{ bitbucket_host_with_port }}"
          - "  {{ 'âœ… Using x-token-auth (correct for Workspace/Repo tokens)' if git_auth_username == 'x-token-auth' else 'âœ… Using Bitbucket username (correct for App Passwords / Server PAT)' }}"
          - "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Create git credentials file with authentication
      ansible.builtin.copy:
        content: |
          http://{{ git_auth_username }}:{{ bitbucket_api_token }}@{{ bitbucket_host_with_port }}
          https://{{ git_auth_username }}:{{ bitbucket_api_token }}@{{ bitbucket_host_with_port }}
        dest: "{{ ansible_env.HOME }}/.git-credentials"
        mode: '0600'
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
      no_log: true

    - name: Verify git_auth_username is set
      ansible.builtin.assert:
        that:
          - git_auth_username is defined
          - git_auth_username | length > 0
        fail_msg: |
          git_auth_username is not defined. This should have been set earlier.
          Please check the authentication setup tasks.
        success_msg: "git_auth_username is set to: {{ git_auth_username }}"
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Build authenticated git URL for cloning
      ansible.builtin.set_fact:
        git_repo_url_with_auth: "{{ git_repo_url | regex_replace('^(https?://)(.*)$', '\\1' + git_auth_username + ':' + bitbucket_api_token + '@\\2') }}"
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - git_auth_username is defined
        - git_repo_url.startswith('http')
      no_log: true

    - name: Use original URL if no credentials or SSH
      ansible.builtin.set_fact:
        git_repo_url_with_auth: "{{ git_repo_url }}"
      when: >
        git_repo_url_with_auth is not defined

    - name: Display masked clone URL for debugging
      ansible.builtin.debug:
        msg: "Clone URL (masked): {{ git_repo_url_with_auth | regex_replace('(https?://)([^:]+):([^@]+)@(.+)', '\\1\\2:***TOKEN***@\\4') if git_repo_url_with_auth is defined else 'Not set' }}"

    - name: Clone git repository
      ansible.builtin.git:
        repo: "{{ git_repo_url_with_auth }}"
        dest: "{{ git_repo_local_path }}"
        version: main
        accept_hostkey: yes
      register: git_clone
      environment:
        GIT_TERMINAL_PROMPT: "0"  # Disable interactive prompts

    - name: Display clone error if failed
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Git Clone Failed!                                             â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "Error: {{ git_clone.msg | default('No error message') }}"
          - "Return Code: {{ git_clone.rc | default('N/A') }}"
          - "Stderr: {{ git_clone.stderr | default('No stderr') }}"
          - ""
          - "Repository: {{ git_repo_url }}"
          - "Username: {{ bitbucket_username }}"
          - "Token Type: {{ 'HTTP Access Token (BBDC)' if token_prefix is defined and token_prefix.startswith('BBDC') else 'Personal Access Token or other' }}"
      when: git_clone is failed

    - name: Display 403 Forbidden specific help
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  HTTP 403 FORBIDDEN - Authentication Rejected                  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Your credentials are being sent but Bitbucket Server is rejecting them.
          
          ðŸ” DETECTED ISSUE:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Token Type: HTTP Access Token (BBDC-...)
          Username: {{ bitbucket_username }}
          Repository: {{ git_repo_url }}
          
          âš ï¸  PROBLEM: HTTP Access Tokens in Bitbucket Data Center
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          HTTP Access Tokens are repository-specific and may not work for
          all git operations. They are typically created at the repository
          level and may have limited scope.
          
          ðŸ”§ SOLUTION: Create a Personal Access Token instead
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          
          Step 1: Log into Bitbucket Server/Data Center
                  http://{{ bitbucket_host_with_port }}
          
          Step 2: Go to your user settings
                  Click your avatar â†’ Manage account
          
          Step 3: Create Personal Access Token
                  Left sidebar â†’ Personal access tokens
                  Click "Create a token"
          
          Step 4: Set permissions (IMPORTANT!)
                  Token name: "AAP Redis Automation"
                  Permissions required:
                    â˜‘ï¸  Project Permissions: Read
                    â˜‘ï¸  Repository Permissions: Read, Write
                    â˜‘ï¸  Pull Request Permissions: Read, Write
          
          Step 5: Click "Create" and copy the token
          
          Step 6: Update AAP Survey with the new Personal Access Token
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ALTERNATIVE: Check Current Token Permissions
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          If you want to keep using this token:
          
          1. Go to: Repository Settings â†’ HTTP access tokens
             http://{{ bitbucket_host_with_port }}/projects/{{ bitbucket_project | default('RED') }}/repos/{{ bitbucket_repo_slug | default('redis') }}/settings/access-tokens
          
          2. Find your token (or the one created for user "{{ bitbucket_username }}")
          
          3. Verify it has:
             â€¢ Read permission: âœ“
             â€¢ Write permission: âœ“
          
          4. Check that user "{{ bitbucket_username }}" has access to project {{ bitbucket_project | default('RED') }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          OTHER POSSIBLE CAUSES:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â€¢ Token expired or was revoked
          â€¢ User "{{ bitbucket_username }}" doesn't have repository access
          â€¢ Repository permissions changed
          â€¢ Project permissions required but not granted
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when:
        - git_clone is failed
        - git_clone.rc is defined
        - git_clone.rc == 128
        - "'403' in git_clone.msg or '403' in git_clone.stderr"

    - name: Fail with detailed error message
      ansible.builtin.fail:
        msg: |
          Git clone failed. See error details above.
          
          Quick Summary:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Repository: {{ git_repo_url }}
          Username: {{ bitbucket_username }}
          Error: {{ git_clone.msg | default('Unknown error') }}
          
          {{ 'âš ï¸  This appears to be a 403 Forbidden error. See the detailed help above.' if (git_clone.rc is defined and git_clone.rc == 128 and ('403' in git_clone.msg or '403' in (git_clone.stderr | default('')))) else '' }}
          
          Next Steps:
          1. Review the error message above
          2. {{ 'Create a Personal Access Token (see instructions above)' if (token_prefix is defined and token_prefix.startswith('BBDC')) else 'Check token permissions in Bitbucket Server' }}
          3. Verify user has repository access
          4. Rerun the job template
      when: git_clone is failed

    - name: Display clone result
      ansible.builtin.debug:
        msg: "âœ“ Repository cloned successfully to {{ git_repo_local_path }}"
      when: git_clone is succeeded

    - name: Extract repository path from URL (Bitbucket Cloud format)
      ansible.builtin.set_fact:
        repo_path: "{{ git_repo_url | regex_replace('^https?://[^@]*@?[^/]+/(.*)$', '\\1') | regex_replace('^git@[^:]+:(.*)$', '\\1') }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Extract repository path from URL (Bitbucket Server format - /scm/PROJECT/repo.git)
      ansible.builtin.set_fact:
        repo_path: "{{ git_repo_url | regex_replace('^https?://[^@]*@?[^/]+/(.*)$', '\\1') }}"
        bitbucket_project: "{{ git_repo_url | regex_replace('^.*/scm/([^/]+)/.*$', '\\1') }}"
        bitbucket_repo_slug: "{{ git_repo_url | regex_replace('^.*/([^/]+)\\.git$', '\\1') | regex_replace('^.*/([^/]+)$', '\\1') }}"
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server

    - name: Display repository path for verification
      ansible.builtin.debug:
        msg:
          - "Bitbucket Host: {{ bitbucket_host_with_port }}"
          - "Repository Path: {{ repo_path }}"
          - "{{ 'Project: ' + bitbucket_project if is_bitbucket_server else '' }}"
          - "{{ 'Repository Slug: ' + bitbucket_repo_slug if is_bitbucket_server else '' }}"
          - "Username: {{ bitbucket_username }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Verify git remote URL (masked)
      ansible.builtin.command:
        cmd: git remote get-url origin
        chdir: "{{ git_repo_local_path }}"
      register: git_remote_url
      changed_when: false
      no_log: false

    - name: Display masked remote URL
      ansible.builtin.debug:
        msg: 
          - "Git remote URL configured:"
          - "  {{ git_remote_url.stdout | regex_replace('(https://)([^:]+):([^@]+)(@.+)', '\\1\\2:***TOKEN***\\4') }}"
          - "  Username for git: {{ git_auth_username }}"
      when: git_remote_url is defined

    - name: Display token type hint
      ansible.builtin.debug:
        msg:
          - "Token prefix detected: {{ token_prefix }}***"
          - "Token length: {{ bitbucket_api_token | length }} characters"
          - "{{ 'Token Type: Workspace Access Token (ATCTT) - Good for Git, not for API' if is_workspace_token else '' }}"
          - "{{ 'Token Type: Repository Access Token (ATATT) - Limited functionality' if is_repo_token else '' }}"
          - "{{ 'Token Type: App Password (ATBB) - Full API support' if is_app_password else '' }}"
          - "{{ 'API Checks: SKIPPED (Workspace tokens do not support API endpoints)' if is_workspace_token else 'API Checks: ENABLED (will attempt API authentication)' }}"
          - ""
          - "{{ 'â„¹ï¸  Workspace Token detected - skipping API tests, will use git operations only' if is_workspace_token else '' }}"
      when: 
        - token_prefix is defined
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    # ============================================================================
    # BITBUCKET CLOUD API AUTHENTICATION TESTS
    # ============================================================================
    
    - name: Test Bitbucket Cloud API authentication with Bearer token
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/user"
        method: GET
        headers:
          Authorization: "Bearer {{ bitbucket_api_token }}"
        status_code: 200
      register: bitbucket_auth_test_bearer
      ignore_errors: yes
      no_log: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud
        - not (is_workspace_token | default(false))
        - not (is_repo_token | default(false))

    - name: Test Bitbucket Cloud API authentication with Basic Auth (App Password)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/user"
        method: GET
        user: "{{ bitbucket_username }}"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        status_code: 200
      register: bitbucket_auth_test_basic
      ignore_errors: yes
      no_log: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud
        - bitbucket_auth_test_bearer is defined
        - bitbucket_auth_test_bearer is failed
        - not (is_workspace_token | default(false))
        - not (is_repo_token | default(false))

    # ============================================================================
    # BITBUCKET SERVER API AUTHENTICATION TEST
    # ============================================================================
    
    - name: Test Bitbucket Server API authentication
      ansible.builtin.uri:
        url: "http://{{ bitbucket_host_with_port }}/rest/api/1.0/application-properties"
        method: GET
        user: "{{ bitbucket_username }}"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        status_code: [200, 401]
        validate_certs: no
      register: bitbucket_server_auth_test
      ignore_errors: yes
      no_log: false
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server

    - name: Set authentication method based on test results (Bitbucket Cloud)
      ansible.builtin.set_fact:
        bitbucket_auth_test: "{{ bitbucket_auth_test_bearer if bitbucket_auth_test_bearer is succeeded else bitbucket_auth_test_basic }}"
        bitbucket_auth_method: "{{ 'bearer' if bitbucket_auth_test_bearer is succeeded else 'basic' }}"
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Set authentication method for Bitbucket Server
      ansible.builtin.set_fact:
        bitbucket_auth_test: "{{ bitbucket_server_auth_test }}"
        bitbucket_auth_method: "basic"
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server
        - bitbucket_server_auth_test is defined

    - name: Display API authentication result (Bitbucket Cloud)
      ansible.builtin.debug:
        msg: 
          - "Bitbucket Cloud API authentication: {{ 'SUCCESS âœ“' if bitbucket_auth_test is succeeded else 'FAILED âœ—' }}"
          - "Authentication method: {{ bitbucket_auth_method | upper if bitbucket_auth_method is defined else 'N/A' }}"
          - "{{ 'Bearer token test failed with: ' + (bitbucket_auth_test_bearer.msg | default('Unknown error')) if bitbucket_auth_test_bearer is defined and bitbucket_auth_test_bearer is failed else '' }}"
          - "{{ 'Basic Auth test failed with: ' + (bitbucket_auth_test_basic.msg | default('Unknown error')) if bitbucket_auth_test_basic is defined and bitbucket_auth_test_basic is failed else '' }}"
      when: 
        - bitbucket_auth_test is defined
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Display API authentication result (Bitbucket Server)
      ansible.builtin.debug:
        msg:
          - "Bitbucket Server API authentication: {{ 'SUCCESS âœ“' if bitbucket_auth_test is succeeded else 'FAILED âœ— (Non-Fatal)' }}"
          - "Authentication method: BASIC AUTH"
          - "API Endpoint: http://{{ bitbucket_host_with_port }}/rest/api/1.0/"
          - "{{ 'Note: API auth failed but git operations should still work' if bitbucket_auth_test is failed else '' }}"
      when:
        - bitbucket_auth_test is defined
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server

    - name: Display API authentication failure details (non-fatal - Bitbucket Cloud)
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  Bitbucket Cloud API Authentication Failed (401 Unauthorized)  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âŒ BOTH authentication methods failed!
          Token prefix: {{ token_prefix }}***
          Token type detected: {{ 'Repository Access Token (WRONG)' if token_prefix is defined and token_prefix.startswith('ATATT') else 'Workspace Access Token (WRONG FOR API)' if token_prefix is defined and token_prefix.startswith('ATCTT') else 'App Password (ATBB) or Unknown' }}
          
          Bearer Token Error: {{ bitbucket_auth_test_bearer.msg | default('N/A') }}
          Basic Auth Error: {{ bitbucket_auth_test_basic.msg | default('N/A') }}
          
          âš ï¸  ISSUE IDENTIFIED:
          
          {% if token_prefix is defined and token_prefix.startswith('ATCTT') %}
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  WRONG TOKEN TYPE: Workspace Access Token (ATCTT)              â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Your token (ATCTT...) is a WORKSPACE ACCESS TOKEN. These tokens:
            âœ“ Work for: HTTP Git operations (clone, push, pull)
            âœ— DO NOT work for: Bitbucket REST API endpoints
          
          The Bitbucket API requires an APP PASSWORD instead!
          
          ðŸ”§ SOLUTION: Create an App Password
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          1. Log into Bitbucket Cloud
          2. Click your profile icon â†’ Personal Settings  
          3. Go to: App passwords (under Access management)
          4. Click "Create app password"
          5. Label: "AAP Redis Automation"
          6. Required Permissions:
             â˜‘ï¸  Account: Read
             â˜‘ï¸  Repositories: Write
             â˜‘ï¸  Pull requests: Write
             â˜‘ï¸  Projects: Write
          7. Click "Create"
          8. Copy the password (typically starts with "ATBB...")
          9. Update your AAP survey with the new App Password
          
          {% elif token_prefix is defined and token_prefix.startswith('ATATT') %}
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  WRONG TOKEN TYPE: Repository Access Token (ATATT)             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Repository Access Tokens do NOT work for API operations!
          You MUST create an APP PASSWORD instead (see instructions above).
          
          {% else %}
          Please verify your token is an App Password with required permissions:
             â˜‘ï¸  Account: Read
             â˜‘ï¸  Repositories: Write
             â˜‘ï¸  Pull requests: Write
          {% endif %}
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ How to Create the Correct Token:                            â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚                                                              â”‚
          â”‚ OPTION 1: Workspace Access Token (Recommended)              â”‚
          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚ 1. Go to Workspace Settings â†’ Access Tokens                 â”‚
          â”‚ 2. Click "Create Access Token"                              â”‚
          â”‚ 3. Name: "AAP Redis Automation"                             â”‚
          â”‚ 4. Scopes:                                                   â”‚
          â”‚    â˜‘ï¸  Workspace: Read                                       â”‚
          â”‚    â˜‘ï¸  Projects: Write                                       â”‚
          â”‚    â˜‘ï¸  Repositories: Write                                   â”‚
          â”‚    â˜‘ï¸  Pull requests: Write                                  â”‚
          â”‚ 5. Copy the token                                            â”‚
          â”‚                                                              â”‚
          â”‚ OPTION 2: Personal Access Token                              â”‚
          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚ 1. Go to Personal Settings â†’ Access Tokens                  â”‚
          â”‚ 2. Click "Create Access Token"                              â”‚
          â”‚ 3. Same scopes as above                                      â”‚
          â”‚                                                              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          IMPORTANT: Where to Create the Token
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… CORRECT LOCATION:
             Bitbucket Cloud â†’ Your Workspace â†’ Settings â†’ Access Tokens
             (NOT in Repository Settings!)
          
          âœ… OR: 
             Bitbucket Cloud â†’ Personal Settings â†’ Access Tokens
          
          âŒ WRONG LOCATION:
             Repository Settings â†’ Access Tokens 
             (These create Repository tokens that DON'T work!)
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Current username: {{ bitbucket_username }}
          {{ 'Current token: ' + token_prefix + '*** (INVALID - Repository Access Token)' if token_prefix is defined and token_prefix.startswith('ATATT') else 'Token type: Unknown' }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          NOTE: This playbook will continue execution!
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          â€¢ Branch will be pushed successfully (uses your workspace token)
          â€¢ You'll get a direct URL to create the PR manually
          â€¢ No API authentication needed for git operations
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when:
        - bitbucket_auth_test is defined
        - bitbucket_auth_test is failed
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Skip API-based PR creation due to auth failure
      ansible.builtin.set_fact:
        skip_api_pr_creation: true
      when:
        - bitbucket_auth_test is defined
        - bitbucket_auth_test is failed

    # ============================================================================
    # REPOSITORY ACCESS TESTS
    # ============================================================================
    
    - name: Extract workspace and repo for repository check (Bitbucket Cloud)
      ansible.builtin.set_fact:
        check_workspace: "{{ git_repo_url | regex_replace('^https?://[^@]*@?[^/]+/([^/]+)/.*$', '\\1') | regex_replace('^git@[^:]+:([^/]+)/.*$', '\\1') }}"
        check_repo_slug: "{{ git_repo_url | regex_replace('^.*/([^/]+)\\.git$', '\\1') | regex_replace('^.*/([^/]+)$', '\\1') }}"
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Test repository access (Bitbucket Cloud - Bearer auth)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/repositories/{{ check_workspace }}/{{ check_repo_slug }}"
        method: GET
        headers:
          Authorization: "Bearer {{ bitbucket_api_token }}"
        status_code: 200
      register: repo_access_test
      ignore_errors: yes
      no_log: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud
        - bitbucket_auth_method is defined
        - bitbucket_auth_method == 'bearer'
        - not (is_workspace_token | default(false))
        - not (is_repo_token | default(false))

    - name: Test repository access (Bitbucket Cloud - Basic auth)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/repositories/{{ check_workspace }}/{{ check_repo_slug }}"
        method: GET
        user: "{{ bitbucket_username }}"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        status_code: 200
      register: repo_access_test
      ignore_errors: yes
      no_log: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud
        - bitbucket_auth_method is defined
        - bitbucket_auth_method == 'basic'
        - not (is_workspace_token | default(false))
        - not (is_repo_token | default(false))

    - name: Test repository access (Bitbucket Server)
      ansible.builtin.uri:
        url: "http://{{ bitbucket_host_with_port }}/rest/api/1.0/projects/{{ bitbucket_project }}/repos/{{ bitbucket_repo_slug }}"
        method: GET
        user: "{{ bitbucket_username }}"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        status_code: 200
        validate_certs: no
      register: repo_access_test
      ignore_errors: yes
      no_log: false
      when:
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server
        - bitbucket_project is defined
        - bitbucket_repo_slug is defined

    - name: Display repository access result (Bitbucket Cloud)
      ansible.builtin.debug:
        msg: 
          - "Repository access check: {{ 'SUCCESS âœ“' if repo_access_test is succeeded else 'FAILED âœ—' }}"
          - "Repository: {{ check_workspace }}/{{ check_repo_slug }}"
      when: 
        - repo_access_test is defined
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Display repository access result (Bitbucket Server)
      ansible.builtin.debug:
        msg:
          - "Repository access check: {{ 'SUCCESS âœ“' if repo_access_test is succeeded else 'FAILED âœ— (Non-Fatal)' }}"
          - "Project: {{ bitbucket_project }}"
          - "Repository: {{ bitbucket_repo_slug }}"
      when:
        - repo_access_test is defined
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server

    - name: Display repository access check failure (non-fatal - Bitbucket Cloud)
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  Repository API Access Check Failed (Non-Fatal)                â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âš ï¸  Cannot verify repository access via API: {{ check_workspace }}/{{ check_repo_slug }}
          
          This is OK! This check only affects API-based PR creation.
          The playbook will continue and:
            âœ… Push your branch using Git (works with Workspace Access Token)
            âœ… Generate a URL for you to create the PR manually
          
          Possible reasons for API failure:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â€¢ Using Workspace Access Token (doesn't support API endpoints)
          â€¢ Token missing API scopes
          â€¢ Repository permissions issue
          
          Repository Details:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â€¢ Repository URL: {{ git_repo_url }}
          â€¢ Workspace: {{ check_workspace }}
          â€¢ Repository: {{ check_repo_slug }}
          â€¢ Username: {{ bitbucket_username }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Continuing with git operations (which will work fine)...
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when:
        - repo_access_test is defined
        - repo_access_test is failed
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Display repository access check failure (non-fatal - Bitbucket Server)
      ansible.builtin.debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  Repository API Access Check Failed (Non-Fatal)                â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âš ï¸  Cannot verify repository access via API
          
          This is OK! This check only affects API-based PR creation.
          The playbook will continue and:
            âœ… Push your branch using Git
            âœ… Generate a URL for you to create the PR manually
          
          Possible reasons for API failure:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â€¢ Token missing API scopes
          â€¢ Repository permissions issue
          â€¢ API endpoint not accessible
          
          Repository Details:
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â€¢ Repository URL: {{ git_repo_url }}
          â€¢ Project: {{ bitbucket_project }}
          â€¢ Repository: {{ bitbucket_repo_slug }}
          â€¢ Username: {{ bitbucket_username }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          Continuing with git operations (which will work fine)...
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when:
        - repo_access_test is defined
        - repo_access_test is failed
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server

    - name: Create deployments directory if it doesn't exist
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'

    - name: Create new git branch
      ansible.builtin.command:
        cmd: git checkout -b {{ git_branch_name }}
        chdir: "{{ git_repo_local_path }}"
      register: git_branch_create

    - name: Set default values for template variables if not provided
      ansible.builtin.set_fact:
        service_ids: "{{ service_ids | default(_service_ids_default) }}"
        redis_roles: "{{ redis_roles | default(_redis_roles_default) }}"
        acls: "{{ acls | default(_acls_default) }}"

    - name: Override with vault credentials if provided
      ansible.builtin.set_fact:
        cluster_admin_password: "{{ vault_cluster_admin_password | default(cluster_admin_password) }}"
        cluster_admin_password_active: "{{ vault_cluster_admin_password_active | default(cluster_admin_password_active) }}"
        bind_pass: "{{ vault_bind_pass | default(bind_pass) }}"
        secret_hi: "{{ vault_secret_hi | default(secret_hi) }}"

    - name: Generate Redis cluster configuration from template
      ansible.builtin.template:
        src: templates/redis_cluster_config.yml.j2
        dest: "{{ output_dir }}/{{ output_filename }}"
        mode: '0644'
      register: template_result

    - name: Display generated file location
      ansible.builtin.debug:
        msg: "âœ“ Configuration file generated: {{ output_dir }}/{{ output_filename }}"

    - name: Validate generated YAML file
      ansible.builtin.command:
        cmd: "python3 -c 'import yaml; yaml.safe_load(open(\"{{ output_dir }}/{{ output_filename }}\"))'"
      register: yaml_validation
      changed_when: false
      failed_when: false
      when: pyyaml_check.rc == 0

    - name: Display YAML validation result
      ansible.builtin.debug:
        msg: "{{ 'YAML validation: PASSED âœ“' if yaml_validation.rc == 0 else 'YAML validation: FAILED âœ— - ' + yaml_validation.stderr }}"
      when: pyyaml_check.rc == 0

    - name: Configure git user for commit
      ansible.builtin.command:
        cmd: "{{ item }}"
        chdir: "{{ git_repo_local_path }}"
      loop:
        - "git config user.name 'Ansible Automation Platform'"
        - "git config user.email 'aap-redis-automation@example.com'"
      changed_when: false

    - name: Stage generated file
      ansible.builtin.command:
        cmd: git add "{{ output_dir }}/{{ output_filename }}"
        chdir: "{{ git_repo_local_path }}"

    - name: Commit changes
      ansible.builtin.command:
        cmd: >
          git commit -m "Add Redis cluster configuration for {{ cluster_name }}"
          -m "Environment: {{ environment }}"
          -m "Redis Version: {{ redis_version }}"
          -m "BDB Version: {{ bdb_version }}"
          -m "Database: {{ database_name }} (Port: {{ database_port }})"
          -m "Memory: {{ memory_size_gb }}GB"
          -m "Cluster Master: {{ cluster_master }}"
          -m ""
          -m "Generated by AAP Job Template: {{ tower_job_template_name | default('Redis Config Generator') }}"
          -m "Job ID: {{ tower_job_id | default('N/A') }}"
          -m "User: {{ tower_user_name | default('Unknown') }}"
        chdir: "{{ git_repo_local_path }}"
      register: git_commit

    - name: Push branch to remote
      ansible.builtin.command:
        cmd: git push origin {{ git_branch_name }}
        chdir: "{{ git_repo_local_path }}"
      register: git_push
      environment:
        GIT_TERMINAL_PROMPT: "0"  # Disable interactive prompts
        GIT_ASKPASS: "echo"  # Prevent password prompts

    # ============================================================================
    # PULL REQUEST CREATION
    # ============================================================================
    
    - name: Extract Bitbucket workspace and repository from URL (Cloud)
      ansible.builtin.set_fact:
        bitbucket_workspace: "{{ git_repo_url | regex_replace('^https?://[^@]*@?[^/]+/([^/]+)/.*$', '\\1') | regex_replace('^git@[^:]+:([^/]+)/.*$', '\\1') }}"
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud
        - bitbucket_repo_slug is not defined

    - name: Debug - Show extracted Bitbucket info (Cloud)
      ansible.builtin.debug:
        msg:
          - "Bitbucket Repo URL: {{ git_repo_url }}"
          - "Extracted Workspace: {{ bitbucket_workspace }}"
          - "Extracted Repo Slug: {{ bitbucket_repo_slug }}"
          - "API URL: https://api.bitbucket.org/2.0/repositories/{{ bitbucket_workspace }}/{{ bitbucket_repo_slug }}/pullrequests"
          - "Source Branch: {{ git_branch_name }}"
          - "Destination Branch: {{ git_default_branch }}"
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud

    - name: Debug - Show extracted Bitbucket info (Server)
      ansible.builtin.debug:
        msg:
          - "Bitbucket Repo URL: {{ git_repo_url }}"
          - "Extracted Project: {{ bitbucket_project }}"
          - "Extracted Repo Slug: {{ bitbucket_repo_slug }}"
          - "API URL: http://{{ bitbucket_host_with_port }}/rest/api/1.0/projects/{{ bitbucket_project }}/repos/{{ bitbucket_repo_slug }}/pull-requests"
          - "Source Branch: {{ git_branch_name }}"
          - "Destination Branch: {{ git_default_branch }}"
      when:
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server

    - name: Create Pull Request using Bitbucket Cloud API (Bearer auth)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/repositories/{{ bitbucket_workspace }}/{{ bitbucket_repo_slug }}/pullrequests"
        method: POST
        headers:
          Authorization: "Bearer {{ bitbucket_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          title: "{{ pr_title }}"
          description: "{{ pr_body }}"
          source:
            branch:
              name: "{{ git_branch_name }}"
          destination:
            branch:
              name: "{{ git_default_branch }}"
          close_source_branch: false
        status_code: 201
        return_content: yes
      register: pr_create
      ignore_errors: yes
      no_log: false
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud
        - bitbucket_auth_method == 'bearer'
        - skip_api_pr_creation is not defined or not skip_api_pr_creation

    - name: Create Pull Request using Bitbucket Cloud API (Basic auth)
      ansible.builtin.uri:
        url: "https://api.bitbucket.org/2.0/repositories/{{ bitbucket_workspace }}/{{ bitbucket_repo_slug }}/pullrequests"
        method: POST
        user: "{{ bitbucket_username }}"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          title: "{{ pr_title }}"
          description: "{{ pr_body }}"
          source:
            branch:
              name: "{{ git_branch_name }}"
          destination:
            branch:
              name: "{{ git_default_branch }}"
          close_source_branch: false
        status_code: 201
        return_content: yes
      register: pr_create
      ignore_errors: yes
      no_log: false
      when: 
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_cloud
        - bitbucket_auth_method == 'basic'
        - skip_api_pr_creation is not defined or not skip_api_pr_creation

    - name: Create Pull Request using Bitbucket Server API
      ansible.builtin.uri:
        url: "http://{{ bitbucket_host_with_port }}/rest/api/1.0/projects/{{ bitbucket_project }}/repos/{{ bitbucket_repo_slug }}/pull-requests"
        method: POST
        user: "{{ bitbucket_username }}"
        password: "{{ bitbucket_api_token }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          title: "{{ pr_title }}"
          description: "{{ pr_body }}"
          fromRef:
            id: "refs/heads/{{ git_branch_name }}"
            repository:
              slug: "{{ bitbucket_repo_slug }}"
              project:
                key: "{{ bitbucket_project }}"
          toRef:
            id: "refs/heads/{{ git_default_branch }}"
            repository:
              slug: "{{ bitbucket_repo_slug }}"
              project:
                key: "{{ bitbucket_project }}"
        status_code: 201
        validate_certs: no
        return_content: yes
      register: pr_create
      ignore_errors: yes
      no_log: false
      when:
        - create_pull_request == 'yes'
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
        - is_bitbucket_server
        - skip_api_pr_creation is not defined or not skip_api_pr_creation

    - name: Debug - Show API error if PR creation failed
      ansible.builtin.debug:
        msg:
          - "âš  PR creation failed!"
          - "Status: {{ pr_create.status | default('N/A') }}"
          - "Message: {{ pr_create.msg | default('N/A') }}"
          - "Response: {{ pr_create.json | default('N/A') }}"
      when: 
        - pr_create is defined
        - pr_create is failed

    - name: Display PR creation result (Bitbucket Cloud - API success)
      ansible.builtin.debug:
        msg: 
          - "âœ“ Pull Request created successfully via Bitbucket Cloud API!"
          - "{{ 'PR #' + (pr_create.json.id | string) + ': ' + pr_create.json.title if pr_create.json is defined and pr_create.json.id is defined else 'PR created but details not available' }}"
          - "{{ 'URL: ' + pr_create.json.links.html.href if pr_create.json is defined and pr_create.json.links is defined else '' }}"
          - "{{ 'Status: ' + pr_create.json.state if pr_create.json is defined and pr_create.json.state is defined else '' }}"
      when: 
        - create_pull_request == 'yes'
        - pr_create is defined
        - pr_create is not skipped
        - pr_create is succeeded
        - pr_create.json is defined
        - is_bitbucket_cloud

    - name: Display PR creation result (Bitbucket Server - API success)
      ansible.builtin.debug:
        msg:
          - "âœ“ Pull Request created successfully via Bitbucket Server API!"
          - "{{ 'PR #' + (pr_create.json.id | string) + ': ' + pr_create.json.title if pr_create.json is defined and pr_create.json.id is defined else 'PR created but details not available' }}"
          - "{{ 'URL: http://' + bitbucket_host_with_port + '/projects/' + bitbucket_project + '/repos/' + bitbucket_repo_slug + '/pull-requests/' + (pr_create.json.id | string) if pr_create.json is defined and pr_create.json.id is defined else '' }}"
          - "{{ 'Status: ' + pr_create.json.state if pr_create.json is defined and pr_create.json.state is defined else '' }}"
      when:
        - create_pull_request == 'yes'
        - pr_create is defined
        - pr_create is not skipped
        - pr_create is succeeded
        - pr_create.json is defined
        - is_bitbucket_server

    - name: Generate PR creation URL (Bitbucket Cloud)
      ansible.builtin.set_fact:
        pr_creation_url: "https://bitbucket.org/{{ bitbucket_workspace | default('WORKSPACE') }}/{{ bitbucket_repo_slug | default('REPO') }}/pull-requests/new?source={{ git_branch_name }}&dest={{ git_default_branch }}"
        workspace_pr_dashboard: "https://bitbucket.org/{{ bitbucket_workspace | default('WORKSPACE') }}/workspace/pull-requests/"
      when: 
        - is_bitbucket_cloud
        - bitbucket_workspace is defined
        - bitbucket_repo_slug is defined

    - name: Generate PR creation URL (Bitbucket Server)
      ansible.builtin.set_fact:
        pr_creation_url: "http://{{ bitbucket_host_with_port }}/projects/{{ bitbucket_project }}/repos/{{ bitbucket_repo_slug }}/pull-requests?create&sourceBranch=refs/heads/{{ git_branch_name }}"
        workspace_pr_dashboard: "http://{{ bitbucket_host_with_port }}/projects/{{ bitbucket_project }}/repos/{{ bitbucket_repo_slug }}/pull-requests"
      when:
        - is_bitbucket_server
        - bitbucket_project is defined
        - bitbucket_repo_slug is defined

    - name: Display PR creation instructions (Bitbucket Cloud)
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Branch Pushed Successfully!                                   â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ“ Branch pushed successfully: {{ git_branch_name }}"
          - "âœ“ Configuration file ready: {{ output_filename }}"
          - ""
          - "ðŸ“‹ Create Pull Request:"
          - "   {{ pr_creation_url if pr_creation_url is defined else 'URL generation skipped' }}"
          - ""
          - "PR Details:"
          - "  â€¢ Title: {{ pr_title }}"
          - "  â€¢ Source: {{ git_branch_name }}"
          - "  â€¢ Destination: {{ git_default_branch }}"
          - "  â€¢ Repository: {{ bitbucket_workspace | default('') }}/{{ bitbucket_repo_slug | default('') }}"
          - ""
          - "ðŸ“Š View all workspace PRs:"
          - "   {{ workspace_pr_dashboard if workspace_pr_dashboard is defined else 'https://bitbucket.org/' + (bitbucket_workspace | default('WORKSPACE')) + '/workspace/pull-requests/' }}"
          - ""
          - "â„¹ï¸  Once created, your PR will appear in both:"
          - "   â€¢ Repository PRs: https://bitbucket.org/{{ bitbucket_workspace }}/{{ bitbucket_repo_slug }}/pull-requests/"
          - "   â€¢ Workspace PRs: https://bitbucket.org/{{ bitbucket_workspace }}/workspace/pull-requests/"
          - ""
      when: 
        - git_branch_name is defined
        - is_bitbucket_cloud

    - name: Display PR creation instructions (Bitbucket Server)
      ansible.builtin.debug:
        msg:
          - ""
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  Branch Pushed Successfully!                                   â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ“ Branch pushed successfully: {{ git_branch_name }}"
          - "âœ“ Configuration file ready: {{ output_filename }}"
          - ""
          - "ðŸ“‹ Create Pull Request:"
          - "   {{ pr_creation_url if pr_creation_url is defined else 'URL generation skipped' }}"
          - ""
          - "PR Details:"
          - "  â€¢ Title: {{ pr_title }}"
          - "  â€¢ Source: {{ git_branch_name }}"
          - "  â€¢ Destination: {{ git_default_branch }}"
          - "  â€¢ Project: {{ bitbucket_project | default('') }}"
          - "  â€¢ Repository: {{ bitbucket_repo_slug | default('') }}"
          - ""
          - "ðŸ“Š View all repository PRs:"
          - "   {{ workspace_pr_dashboard if workspace_pr_dashboard is defined else 'URL not available' }}"
          - ""
      when:
        - git_branch_name is defined
        - is_bitbucket_server

    - name: Cleanup temporary repository
      ansible.builtin.file:
        path: "{{ git_repo_local_path }}"
        state: absent
      when: git_repo_local_path is defined and git_repo_local_path.startswith('/tmp/')

    - name: Cleanup git credentials file
      ansible.builtin.file:
        path: "{{ ansible_env.HOME }}/.git-credentials"
        state: absent
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0
      no_log: true

    - name: Reset git credential helper
      ansible.builtin.command:
        cmd: git config --global --unset credential.helper
      changed_when: false
      failed_when: false
      when: 
        - bitbucket_username | default('') | length > 0
        - bitbucket_api_token | default('') | length > 0

    - name: Final Summary (Bitbucket Cloud)
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  AAP Job Complete!                                             â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ“ Configuration generated for: {{ cluster_name }}"
          - "âœ“ Environment: {{ environment | upper }}"
          - "âœ“ File: {{ output_filename }}"
          - "âœ“ Branch: {{ git_branch_name }}"
          - "{{ 'âœ“ Pull Request created via API' if (create_pull_request == 'yes' and pr_create is defined and pr_create is succeeded) else 'âœ“ Branch pushed - create PR manually' }}"
          - ""
          - "ðŸ“Š View All Workspace Pull Requests:"
          - "   https://bitbucket.org/{{ bitbucket_workspace | default('WORKSPACE') }}/workspace/pull-requests/"
          - ""
          - "Next steps:"
          - "  1. Review the Pull Request"
          - "  2. Get necessary approvals"
          - "  3. Merge to main branch"
          - "  4. Deploy using the generated configuration"
          - ""
          - "AAP Job ID: {{ tower_job_id | default('N/A') }}"
          - "Executed by: {{ tower_user_name | default('Unknown') }}"
      when: is_bitbucket_cloud

    - name: Final Summary (Bitbucket Server)
      ansible.builtin.debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘  AAP Job Complete!                                             â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          - ""
          - "âœ“ Configuration generated for: {{ cluster_name }}"
          - "âœ“ Environment: {{ environment | upper }}"
          - "âœ“ File: {{ output_filename }}"
          - "âœ“ Branch: {{ git_branch_name }}"
          - "{{ 'âœ“ Pull Request created via API' if (create_pull_request == 'yes' and pr_create is defined and pr_create is succeeded) else 'âœ“ Branch pushed - create PR manually' }}"
          - ""
          - "ðŸ“Š View All Repository Pull Requests:"
          - "   http://{{ bitbucket_host_with_port }}/projects/{{ bitbucket_project | default('PROJECT') }}/repos/{{ bitbucket_repo_slug | default('REPO') }}/pull-requests"
          - ""
          - "Next steps:"
          - "  1. Review the Pull Request"
          - "  2. Get necessary approvals"
          - "  3. Merge to main branch"
          - "  4. Deploy using the generated configuration"
          - ""
          - "AAP Job ID: {{ tower_job_id | default('N/A') }}"
          - "Executed by: {{ tower_user_name | default('Unknown') }}"
      when: is_bitbucket_server

